name: Build and Deploy to GitHub Container Registry

on:
  push:
    branches: 
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}-backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}-frontend
  IMAGE_NAME_FULL: ${{ github.repository }}-full

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          backend/package-lock.json
          frontend/package-lock.json

    - name: Install backend dependencies
      run: |
        cd backend
        npm ci

    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci

    - name: Lint backend
      run: |
        cd backend
        npm run lint

    - name: Lint frontend
      run: |
        cd frontend
        npm run lint

    - name: Test backend
      run: |
        cd backend
        npm test

    - name: Build backend
      run: |
        cd backend
        npm run build

    - name: Build frontend
      run: |
        cd frontend
        npm run build

  # æ„å»ºå¹¶æ¨é€é•œåƒ
  build-and-push:
    needs: quality-check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    strategy:
      matrix:
        component: [backend, frontend, full]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FULL }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=ref,event=tag
          type=raw,value=latest,enable={{is_default_branch}}
          type=sha,prefix={{branch}}-,suffix=-{{date 'YYYYMMDD-HHmmss'}},enable={{is_default_branch}}

    # Backend é•œåƒæ„å»º
    - name: Build and push Backend image
      if: matrix.component == 'backend'
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.ref_name }}
        labels: |
          org.opencontainers.image.title=WordPecker Backend
          org.opencontainers.image.description=WordPecker language learning app backend
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

    # Frontend é•œåƒæ„å»º
    - name: Build and push Frontend image
      if: matrix.component == 'frontend'
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.ref_name }}
        labels: |
          org.opencontainers.image.title=WordPecker Frontend
          org.opencontainers.image.description=WordPecker language learning app frontend
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

    # å®Œæ•´åº”ç”¨é•œåƒæ„å»º (ä½¿ç”¨ docker-compose)
    - name: Build and push Full application image
      if: matrix.component == 'full'
      run: |
        # åˆ›å»ºå®Œæ•´åº”ç”¨çš„ Dockerfile
        cat > Dockerfile.full << EOF
        FROM docker/compose:latest
        
        # å®‰è£…å¿…è¦å·¥å…·
        RUN apk add --no-cache curl jq
        
        # å¤åˆ¶åº”ç”¨æ–‡ä»¶
        COPY . /app
        WORKDIR /app
        
        # è®¾ç½®å¯åŠ¨è„šæœ¬
        COPY scripts/start-full.sh /start.sh
        RUN chmod +x /start.sh
        
        EXPOSE 3000 3001 27017
        
        CMD ["/start.sh"]
        EOF
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        mkdir -p scripts
        cat > scripts/start-full.sh << 'EOF'
        #!/bin/sh
        echo "Starting WordPecker Full Application..."
        
        # ç­‰å¾… Docker daemon å°±ç»ª
        while ! docker info >/dev/null 2>&1; do
          echo "Waiting for Docker daemon..."
          sleep 2
        done
        
        # å¯åŠ¨æœåŠ¡
        docker-compose up --build
        EOF
        
        # æ„å»ºå¹¶æ¨é€å®Œæ•´é•œåƒ
        docker build -f Dockerfile.full -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FULL }}:latest .
        docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FULL }}:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FULL }}:${{ github.sha }}
        docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FULL }}:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FULL }}:${{ github.ref_name }}
        
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FULL }}:latest
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FULL }}:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FULL }}:${{ github.ref_name }}

    # ç”Ÿæˆå®‰å…¨æŠ¥å‘Šå’Œæ„å»ºè¯æ˜
    - name: Generate SBOM and security scan
      if: matrix.component != 'full'
      run: |
        # ç”Ÿæˆè½¯ä»¶æ¸…å• (SBOM)
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
          -v $(pwd):/workspace \
          anchore/syft:latest \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest \
          -o spdx-json=backend-sbom.json || true
          
        # å®‰å…¨æ‰«æ
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
          -v $(pwd):/workspace \
          anchore/grype:latest \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest \
          -o json --file backend-vulnerabilities.json || true

    - name: Upload SBOM and security reports
      if: matrix.component != 'full'
      uses: actions/upload-artifact@v4
      with:
        name: security-reports-${{ matrix.component }}
        path: |
          *-sbom.json
          *-vulnerabilities.json

  # éƒ¨ç½²åˆ° GitHub Pages (æ–‡æ¡£å’Œæ¼”ç¤º)
  deploy-docs:
    if: github.ref == 'refs/heads/main'
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Generate deployment documentation
      run: |
        mkdir -p docs-build
        
        # Set variables for easier template substitution
        REPO_NAME="${{ github.repository }}"
        COMMIT_SHA="${{ github.sha }}"
        REF_NAME="${{ github.ref_name }}"
        EVENT_NAME="${{ github.event_name }}"
        
        # Create deployment documentation
        cat > docs-build/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>WordPecker App - Deployment Guide</title>
            <meta charset="utf-8">
            <style>
                body { font-family: system-ui, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
                .container { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; }
                code { background: #eee; padding: 2px 4px; border-radius: 3px; }
                pre { background: #333; color: #fff; padding: 15px; border-radius: 5px; overflow-x: auto; }
                .status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
                .success { background: #4caf50; color: white; }
                .info { background: #2196f3; color: white; }
            </style>
        </head>
        <body>
            <h1>ğŸ¯ WordPecker App - éƒ¨ç½²æŒ‡å—</h1>
            
            <div class="container">
                <h2>ğŸ“¦ å®¹å™¨é•œåƒ</h2>
                <p>æœ€æ–°æ„å»ºçš„é•œåƒå·²æ¨é€åˆ° GitHub Container Registry:</p>
                <ul>
                    <li><code>ghcr.io/REPO_PLACEHOLDER-backend:latest</code></li>
                    <li><code>ghcr.io/REPO_PLACEHOLDER-frontend:latest</code></li>
                    <li><code>ghcr.io/REPO_PLACEHOLDER-full:latest</code></li>
                </ul>
                <span class="status success">BUILD ID: COMMIT_PLACEHOLDER</span>
                <span class="status info">DATE: $(date)</span>
            </div>
            
            <div class="container">
                <h2>ğŸš€ å¿«é€Ÿéƒ¨ç½²</h2>
                <h3>æ–¹å¼1: ä½¿ç”¨ç‹¬ç«‹å®¹å™¨</h3>
                <pre><code># æ‹‰å–é•œåƒ
docker pull ghcr.io/REPO_PLACEHOLDER-backend:latest
docker pull ghcr.io/REPO_PLACEHOLDER-frontend:latest

# åˆ›å»ºç½‘ç»œ
docker network create wordpecker-net

# å¯åŠ¨ MongoDB
docker run -d --name wordpecker-mongo \
  --network wordpecker-net \
  -e MONGO_INITDB_ROOT_USERNAME=admin \
  -e MONGO_INITDB_ROOT_PASSWORD=password \
  -e MONGO_INITDB_DATABASE=wordpecker \
  -p 27017:27017 \
  mongo:7.0

# å¯åŠ¨åç«¯ (éœ€è¦è®¾ç½®ç¯å¢ƒå˜é‡)
docker run -d --name wordpecker-backend \
  --network wordpecker-net \
  -e NODE_ENV=production \
  -e MONGODB_URL=mongodb://admin:password@wordpecker-mongo:27017/wordpecker?authSource=admin \
  -e OPENAI_API_KEY=your_openai_api_key \
  -p 3001:3000 \
  ghcr.io/REPO_PLACEHOLDER-backend:latest

# å¯åŠ¨å‰ç«¯
docker run -d --name wordpecker-frontend \
  --network wordpecker-net \
  -e VITE_API_URL=http://localhost:3001 \
  -p 3000:3000 \
  ghcr.io/REPO_PLACEHOLDER-frontend:latest</code></pre>

                <h3>æ–¹å¼2: ä½¿ç”¨ Docker Compose</h3>
                <pre><code># ä¸‹è½½ docker-compose.yml
curl -O https://raw.githubusercontent.com/REPO_PLACEHOLDER/main/docker-compose.yml

# è®¾ç½®ç¯å¢ƒå˜é‡
echo "OPENAI_API_KEY=your_openai_api_key" > .env
echo "ELEVENLABS_API_KEY=your_elevenlabs_api_key" >> .env
echo "PEXELS_API_KEY=your_pexels_api_key" >> .env

# å¯åŠ¨åº”ç”¨
docker-compose up -d</code></pre>
            </div>
            
            <div class="container">
                <h2>ğŸŒ è®¿é—®åº”ç”¨</h2>
                <ul>
                    <li><strong>å‰ç«¯åº”ç”¨:</strong> <a href="http://localhost:3000">http://localhost:3000</a></li>
                    <li><strong>åç«¯ API:</strong> <a href="http://localhost:3001">http://localhost:3001</a></li>
                    <li><strong>MongoDB:</strong> localhost:27017 (admin/password)</li>
                </ul>
            </div>
            
            <div class="container">
                <h2>âš™ï¸ ç¯å¢ƒå˜é‡é…ç½®</h2>
                <p>å¿…éœ€çš„ç¯å¢ƒå˜é‡:</p>
                <ul>
                    <li><strong>OPENAI_API_KEY:</strong> OpenAI API å¯†é’¥ (å¿…éœ€)</li>
                    <li><strong>ELEVENLABS_API_KEY:</strong> ElevenLabs API å¯†é’¥ (å¯é€‰ï¼Œç”¨äºè¯­éŸ³åŠŸèƒ½)</li>
                    <li><strong>PEXELS_API_KEY:</strong> Pexels API å¯†é’¥ (å¯é€‰ï¼Œç”¨äºå›¾ç‰‡åŠŸèƒ½)</li>
                </ul>
            </div>
            
            <div class="container">
                <h2>ğŸ“ éƒ¨ç½²ä¿¡æ¯</h2>
                <ul>
                    <li><strong>æ„å»ºæ—¶é—´:</strong> $(date)</li>
                    <li><strong>Commit SHA:</strong> COMMIT_PLACEHOLDER</li>
                    <li><strong>åˆ†æ”¯:</strong> REF_PLACEHOLDER</li>
                    <li><strong>è§¦å‘äº‹ä»¶:</strong> EVENT_PLACEHOLDER</li>
                </ul>
            </div>
        </body>
        </html>
        EOF
        
        # Replace placeholders with actual values
        sed -i "s/REPO_PLACEHOLDER/${REPO_NAME}/g" docs-build/index.html
        sed -i "s/COMMIT_PLACEHOLDER/${COMMIT_SHA}/g" docs-build/index.html
        sed -i "s/REF_PLACEHOLDER/${REF_NAME}/g" docs-build/index.html
        sed -i "s/EVENT_PLACEHOLDER/${EVENT_NAME}/g" docs-build/index.html

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs-build

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  # é€šçŸ¥å’ŒæŠ¥å‘Š
  notification:
    if: always()
    needs: [quality-check, build-and-push, deploy-docs]
    runs-on: ubuntu-latest
    
    steps:
    - name: Create deployment summary
      run: |
        echo "## ğŸš€ WordPecker App éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "### æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘äº‹ä»¶:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ„å»ºæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ—ï¸ æ„å»ºçš„é•œåƒ" >> $GITHUB_STEP_SUMMARY
        echo "- \`ghcr.io/${{ github.repository }}-backend:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`ghcr.io/${{ github.repository }}-frontend:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`ghcr.io/${{ github.repository }}-full:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸŒ éƒ¨ç½²åœ°å€" >> $GITHUB_STEP_SUMMARY
        echo "- **éƒ¨ç½²æ–‡æ¡£:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å®¹å™¨é•œåƒ:** https://github.com/${{ github.repository }}/pkgs/container" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ å¿«é€Ÿå¯åŠ¨" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "# ä¸‹è½½é…ç½®æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "curl -O https://raw.githubusercontent.com/${{ github.repository }}/main/docker-compose.yml" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# è®¾ç½®ç¯å¢ƒå˜é‡" >> $GITHUB_STEP_SUMMARY
        echo "echo 'OPENAI_API_KEY=your_openai_api_key' > .env" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# å¯åŠ¨åº”ç”¨" >> $GITHUB_STEP_SUMMARY
        echo "docker-compose up -d" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Report status
      if: failure()
      run: |
        echo "## âŒ éƒ¨ç½²å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—å¹¶ä¿®å¤é—®é¢˜åé‡è¯•ã€‚" >> $GITHUB_STEP_SUMMARY