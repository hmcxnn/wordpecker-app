name: Build and Deploy to GitHub Container Registry

on:
  push:
    branches: 
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}-backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}-frontend
  IMAGE_NAME_FULL: ${{ github.repository }}-full

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: |
          backend/package-lock.json
          frontend/package-lock.json

    - name: Install backend dependencies
      run: |
        cd backend
        rm -f package-lock.json
        npm install

    - name: Install frontend dependencies
      run: |
        cd frontend
        rm -f package-lock.json
        npm install

    - name: Lint backend
      run: |
        cd backend
        npm run lint || echo "ESLint warnings found but continuing build"

    - name: Lint frontend
      run: |
        cd frontend
        npm run lint || echo "ESLint warnings found but continuing build"

    - name: Test backend
      run: |
        cd backend
        npm test -- --passWithNoTests

    - name: Build backend
      run: |
        cd backend
        npm run build

    - name: Build frontend
      run: |
        cd frontend
        npm run build

  # æ„å»ºå¹¶æ¨é€é•œåƒ
  build-and-push:
    needs: quality-check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    strategy:
      matrix:
        component: [backend, frontend, full]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FULL }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=ref,event=tag
          type=raw,value=latest,enable={{is_default_branch}}
          type=sha,prefix={{branch}}-,suffix=-{{date 'YYYYMMDD-HHmmss'}},enable={{is_default_branch}}

    # Backend é•œåƒæ„å»º
    - name: Build and push Backend image
      if: matrix.component == 'backend'
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.ref_name }}
        labels: |
          org.opencontainers.image.title=WordPecker Backend
          org.opencontainers.image.description=WordPecker language learning app backend
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

    # Frontend é•œåƒæ„å»º
    - name: Build and push Frontend image
      if: matrix.component == 'frontend'
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.ref_name }}
        labels: |
          org.opencontainers.image.title=WordPecker Frontend
          org.opencontainers.image.description=WordPecker language learning app frontend
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

    # å®Œæ•´åº”ç”¨é•œåƒæ„å»º (ä½¿ç”¨ docker-compose)
    - name: Build and push Full application image
      if: matrix.component == 'full'
      run: |
        # åˆ›å»ºå®Œæ•´åº”ç”¨çš„ Dockerfile
        cat > Dockerfile.full << EOF
        FROM docker/compose:latest
        
        # å®‰è£…å¿…è¦å·¥å…·
        RUN apk add --no-cache curl jq
        
        # å¤åˆ¶åº”ç”¨æ–‡ä»¶
        COPY . /app
        WORKDIR /app
        
        # è®¾ç½®å¯åŠ¨è„šæœ¬
        COPY scripts/start-full.sh /start.sh
        RUN chmod +x /start.sh
        
        EXPOSE 3000 3001 27017
        
        CMD ["/start.sh"]
        EOF
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        mkdir -p scripts
        cat > scripts/start-full.sh << 'EOF'
        #!/bin/sh
        echo "Starting WordPecker Full Application..."
        
        # ç­‰å¾… Docker daemon å°±ç»ª
        while ! docker info >/dev/null 2>&1; do
          echo "Waiting for Docker daemon..."
          sleep 2
        done
        
        # å¯åŠ¨æœåŠ¡
        docker-compose up --build
        EOF
        
        # æ„å»ºå¹¶æ¨é€å®Œæ•´é•œåƒ
        docker build -f Dockerfile.full -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FULL }}:latest .
        docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FULL }}:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FULL }}:${{ github.sha }}
        docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FULL }}:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FULL }}:${{ github.ref_name }}
        
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FULL }}:latest
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FULL }}:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FULL }}:${{ github.ref_name }}

    # ç”Ÿæˆå®‰å…¨æŠ¥å‘Šå’Œæ„å»ºè¯æ˜
    - name: Generate SBOM and security scan
      if: matrix.component != 'full'
      run: |
        # ç”Ÿæˆè½¯ä»¶æ¸…å• (SBOM)
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
          -v $(pwd):/workspace \
          anchore/syft:latest \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest \
          -o spdx-json=backend-sbom.json || true
          
        # å®‰å…¨æ‰«æ
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
          -v $(pwd):/workspace \
          anchore/grype:latest \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest \
          -o json --file backend-vulnerabilities.json || true

    - name: Upload SBOM and security reports
      if: matrix.component != 'full'
      uses: actions/upload-artifact@v4
      with:
        name: security-reports-${{ matrix.component }}
        path: |
          *-sbom.json
          *-vulnerabilities.json

  # éƒ¨ç½²åˆ° GitHub Pages (æ–‡æ¡£å’Œæ¼”ç¤º) - å¯é€‰
  deploy-docs:
    if: github.ref == 'refs/heads/main'
    needs: build-and-push
    runs-on: ubuntu-latest
    continue-on-error: true  # å…è®¸ Pages éƒ¨ç½²å¤±è´¥è€Œä¸å½±å“ä¸»è¦æ„å»º
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Pages
      uses: actions/configure-pages@v4
      continue-on-error: true  # å¦‚æœ Pages æœªå¯ç”¨ï¼Œç»§ç»­æ‰§è¡Œ

    - name: Create deployment documentation
      run: |
        mkdir -p docs-build
        echo '<html><head><title>WordPecker App</title></head><body>' > docs-build/index.html
        echo '<h1>WordPecker App - Deployment Guide</h1>' >> docs-build/index.html
        echo '<p>Repository: ${{ github.repository }}</p>' >> docs-build/index.html
        echo '<p>Commit: ${{ github.sha }}</p>' >> docs-build/index.html
        echo '<p>Images available at: ghcr.io/${{ github.repository }}-backend:latest</p>' >> docs-build/index.html
        echo '<h2>å¿«é€Ÿå¯åŠ¨</h2>' >> docs-build/index.html
        echo '<pre><code>' >> docs-build/index.html
        echo '# ä½¿ç”¨å‘å¸ƒçš„é•œåƒå¯åŠ¨åº”ç”¨' >> docs-build/index.html
        echo 'docker run -d -p 3001:3000 ghcr.io/${{ github.repository }}-backend:latest' >> docs-build/index.html
        echo 'docker run -d -p 3000:3000 ghcr.io/${{ github.repository }}-frontend:latest' >> docs-build/index.html
        echo '</code></pre>' >> docs-build/index.html
        echo '</body></html>' >> docs-build/index.html

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs-build
      continue-on-error: true  # å¦‚æœä¸Šä¼ å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      continue-on-error: true  # å¦‚æœéƒ¨ç½²å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ

    - name: Pages deployment status
      run: |
        if [ "${{ steps.deployment.outcome }}" == "success" ]; then
          echo "âœ… GitHub Pages éƒ¨ç½²æˆåŠŸ"
          echo "ğŸ“„ æ–‡æ¡£åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        else
          echo "âš ï¸ GitHub Pages éƒ¨ç½²è·³è¿‡æˆ–å¤±è´¥"
          echo "ğŸ’¡ å¦‚éœ€å¯ç”¨ Pagesï¼Œè¯·åœ¨ä»“åº“è®¾ç½®ä¸­å¯ç”¨ GitHub Pages å¹¶é€‰æ‹© 'GitHub Actions' ä½œä¸ºæº"
        fi

  # é€šçŸ¥å’ŒæŠ¥å‘Š
  notification:
    if: always()
    needs: [quality-check, build-and-push]  # ç§»é™¤å¯¹ deploy-docs çš„ä¾èµ–
    runs-on: ubuntu-latest
    
    steps:
    - name: Create deployment summary
      run: |
        echo "## ğŸš€ WordPecker App éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "### æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘äº‹ä»¶:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ„å»ºæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ—ï¸ æ„å»ºçš„é•œåƒ" >> $GITHUB_STEP_SUMMARY
        echo "- \`ghcr.io/${{ github.repository }}-backend:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`ghcr.io/${{ github.repository }}-frontend:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`ghcr.io/${{ github.repository }}-full:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸŒ éƒ¨ç½²åœ°å€" >> $GITHUB_STEP_SUMMARY
        echo "- **å®¹å™¨é•œåƒ:** https://github.com/${{ github.repository }}/pkgs/container" >> $GITHUB_STEP_SUMMARY
        echo "- **æ³¨æ„:** å¦‚éœ€å¯ç”¨ GitHub Pages æ–‡æ¡£ï¼Œè¯·åœ¨ä»“åº“è®¾ç½®ä¸­å¯ç”¨å¹¶é€‰æ‹© 'GitHub Actions' ä½œä¸ºæº" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ å¿«é€Ÿå¯åŠ¨" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "# ä¸‹è½½é…ç½®æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "curl -O https://raw.githubusercontent.com/${{ github.repository }}/main/docker-compose.yml" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# è®¾ç½®ç¯å¢ƒå˜é‡" >> $GITHUB_STEP_SUMMARY
        echo "echo 'OPENAI_API_KEY=your_openai_api_key' > .env" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# å¯åŠ¨åº”ç”¨" >> $GITHUB_STEP_SUMMARY
        echo "docker-compose up -d" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Report status
      if: failure()
      run: |
        echo "## âŒ éƒ¨ç½²å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—å¹¶ä¿®å¤é—®é¢˜åé‡è¯•ã€‚" >> $GITHUB_STEP_SUMMARY